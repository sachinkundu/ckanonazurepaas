---
  parameters:
    - name: location
      default: westeurope
      type: string
      
    - name: ckan_image
      default: sachinkundu/ckan:v1
      type: string

    - name: postgres_password
      type: string

    - name: solr_password
      type: string        
  
  variables:
  - template: dev.yaml  
  - name: azureResourceManagerConnection
    value: SC-${{ variables.resourceGroup }}        
  
  steps:
    - task: AzureResourceManagerTemplateDeployment@3
      displayName: Create CKAN Azure Container Instances
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '${{ variables.azureResourceManagerConnection }}'
        subscriptionId: ${{ variables.subscriptionId }}
        action: 'Create Or Update Resource Group'
        resourceGroupName: '${{ variables.resourceGroup }}'
        location: ${{ parameters.location }}
        templateLocation: 'Linked artifact'
        csmFile: './frontend-ui/arm-templates/aci-template.json'
        csmParametersFile: './frontend-ui/arm-templates/aci-parameters.json'
        overrideParameters: >
            -name ${{ variables.frontendname }}
            -ckan_image ${{ parameters.ckan_image }}
            -postgres_hostname ${{ variables.postgres_hostname }}
            -postgres_password ${{ parameters.postgres_password }}
            -solr_url ${{ variables.solr_url }}
            -solr_password ${{ parameters.solr_password }}
        deploymentMode: 'Incremental'
  