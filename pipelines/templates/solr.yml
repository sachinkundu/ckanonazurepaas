---
parameters:
  - name: solrVersion
    default: "6.5.1"
    type: string

  - name: location
    default: westeurope
    type: string

  - name: skuName
    default: B1
    type: string

  - name: solrCoreName
    default: ckan
    type: string

variables:
  - template: dev.yaml  
  - name: azureResourceManagerConnection
    value: SC-${{ variables.resourceGroup }}
  - name: solr_password
    value: $(SOLRPASSWORD)
  - name: solr_url
    value: $(SolrDeployment.AppServiceApplicationUrl)/solr

steps:

- task: AzureKeyVault@1
  inputs:
    azureSubscription: ${{ variables.azureResourceManagerConnection }}
    keyVaultName: ${{ variables.keyVaultName }}
    secretsFilter: "SOLRPASSWORD"
    runAsPreJob: false

- task: PowerShell@2
  inputs:
    filePath: './scripts/solr/New-SolrPackage.ps1'
    pwsh: true
    arguments:
      -solrVersion  ${{ parameters.solrVersion }}
      -configDir ./configuration/solr
  displayName: Create Solr package

- task: AzureResourceManagerTemplateDeployment@3
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '${{ variables.azureResourceManagerConnection }}'
    subscriptionId: ${{ variables.subscriptionId }}
    action: 'Create Or Update Resource Group'
    resourceGroupName: '${{ variables.resourceGroup }}'
    location: ${{ parameters.location }}
    templateLocation: 'Linked artifact'
    csmFile: './arm-templates/solr.json'
    csmParametersFile: './arm-templates/solr.parameters.json'
    overrideParameters: >
      -webAppName ${{ variables.solrAppName }}
      -location ${{ parameters.location }}
      -skuName ${{ parameters.skuName }}
    deploymentMode: 'Incremental'
    deploymentOutputs: 'solrDeployOutput'
  displayName: Create Solr webapp

- task: AzureRmWebAppDeployment@4
  name: SolrDeployment
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: '${{ variables.azureResourceManagerConnection }}'
    appType: 'webAppLinux'
    WebAppName: ${{ variables.solrAppName }}
    packageForLinux: '$(System.DefaultWorkingDirectory)/**/solr_setup_package.zip'
  displayName: Setup Solr

- task: PowerShell@2
  inputs:
    filePath: './scripts/solr/Set-Solr.ps1'
    pwsh: true
    arguments:
      -solrUrl $(solr_url)
      -solrPassword ${{ variables.solr_password }}
      -coreName ${{ parameters.solrCoreName }}
  displayName: Finish Solr installation